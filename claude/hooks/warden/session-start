#!/usr/bin/env bash
# session-start: Track session and terminal agent start
set -euo pipefail

# Source shared library
source "${BASH_SOURCE[0]%/*}/lib/common.sh"

_warden_read_input || exit 0

SESSION_ID=$(_warden_parse_session_id)
SESSION_ID=$(_warden_sanitize_id "$SESSION_ID")
AGENT_STATS="$HOME/.claude/agent-stats.csv"

if [ -n "$SESSION_ID" ]; then
  mkdir -p "$HOME/.claude/.session-times"
  mkdir -p "$WARDEN_SESSION_BUDGET_DIR"
  date +%s > "$HOME/.claude/.session-times/$SESSION_ID.start"
  _warden_date_sns > "$HOME/.claude/.session-times/$SESSION_ID.start_ns"
  # Warden TUI: record session start for relative timestamps
  mkdir -p "$WARDEN_STATE_DIR"
  _warden_date_sns > "$WARDEN_STATE_DIR/.session_start"

  # Snapshot budget at session start
  _warden_budget_export > "$WARDEN_SESSION_BUDGET_DIR/$SESSION_ID.start.json" 2>/dev/null || true
  _warden_write_budget_prom

  # Initialize unified agent stats CSV with header if needed
  if [ ! -f "$AGENT_STATS" ]; then
    echo "timestamp,agent_id,agent_category,agent_type,duration_seconds,session_id,status" > "$AGENT_STATS"
  fi

  # Log terminal agent start
  echo "$(_warden_date_iso),terminal-$SESSION_ID,terminal,main,0,$SESSION_ID,started" >> "$AGENT_STATS"

  # Emit session_start event to events.jsonl for Loki/Grafana
  # session_label: "dirname (last6 of session_id)" â€” used in Session Index/Detail dashboards
  SESSION_LABEL="$(basename "$PWD") (${SESSION_ID: -6})"
  printf '{"timestamp":0,"event_type":"session_start","tool":"SessionStart","session_id":"%s","cwd":"%s","session_label":"%s"}\n' \
    "$SESSION_ID" "$PWD" "$SESSION_LABEL" \
    >> "$WARDEN_EVENTS_FILE" 2>/dev/null
fi

exit 0
